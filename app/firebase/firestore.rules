rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // User profile
      match /profile {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Module progress tracking
      match /module_progress/{moduleId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Module content and entries
      match /modules/{moduleId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        match /submodules/{submoduleId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
          
          match /entries/{entryId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
          
          match /discarded/{discardedId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
        }
      }
      
      // Freeform journal entries
      match /freeform_entries/{entryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Freeform discarded prompts
      match /freeform_discarded/{discardedId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Journal entries (legacy)
      match /journal_entries/{entryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Meal logs
      match /meal_logs/{logId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Behavior logs
      match /behavior_logs/{logId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Legacy collections (for backward compatibility)
    match /chatSessions/{sessionId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    match /meals/{mealId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    match /behaviors/{behaviorId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    match /emergencyContacts/{contactId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    match /safetyPlans/{planId} {
      allow read, write: if request.auth != null && request.auth.uid == planId;
    }
  }
} 